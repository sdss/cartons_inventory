

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cartons_inventory.cartons &#8212; cartons_inventory 0.1.0a0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom_bootstrap.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon_sdssv.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><span><img src="../../_static/sdssv_logo_small.png"></span>
          SDSS: cartons_inventory</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG.html">What's new in cartons_inventory?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction to cartons_inventory</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">cartons_inventory Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-cartons_inventory.cartons">Cartons</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <h1>Source code for cartons_inventory.cartons</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">sdssdb.peewee.sdss5db.targetdb</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Cadence</span><span class="p">,</span> <span class="n">Carton</span><span class="p">,</span> <span class="n">CartonToTarget</span><span class="p">,</span>
                                            <span class="n">Category</span><span class="p">,</span> <span class="n">Instrument</span><span class="p">,</span> <span class="n">Magnitude</span><span class="p">,</span>
                                            <span class="n">Mapper</span><span class="p">,</span> <span class="n">Version</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">cartons_inventory</span>
<span class="kn">from</span> <span class="nn">cartons_inventory</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">main</span>


<span class="n">Car</span> <span class="o">=</span> <span class="n">Carton</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
<span class="n">CarTar</span> <span class="o">=</span> <span class="n">CartonToTarget</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
<span class="n">Cad</span> <span class="o">=</span> <span class="n">Cadence</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
<span class="n">Inst</span> <span class="o">=</span> <span class="n">Instrument</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
<span class="n">Categ</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
<span class="n">Map</span> <span class="o">=</span> <span class="n">Mapper</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
<span class="n">Mag</span> <span class="o">=</span> <span class="n">Magnitude</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>


<div class="viewcode-block" id="CartonInfo"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.CartonInfo">[docs]</a><span class="k">class</span> <span class="nc">CartonInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Saves targetdb info for cartons.</span>

<span class="sd">    This class takes basic information from a carton (``name``, ``plan``, and ``category_label``</span>
<span class="sd">    at minimum) and at instantiation sets the carton dependent (as opposed to target dependent)</span>
<span class="sd">    information of the carton. ``stage`` and ``active`` parameters can also be provided but</span>
<span class="sd">    currently nothing is done with those. Carton dependent information is either taken from</span>
<span class="sd">    input parameters of __init__ or by the assign_carton_info function that also set the</span>
<span class="sd">    boolean in_targetdb to check the existence of the carton.</span>

<span class="sd">    Then, function assign_target_info assigns target dependent information which can be</span>
<span class="sd">    the magnitude placholders used for the different photometric system in the carton</span>
<span class="sd">    (calculate_mag_placeholders=True), and/or python sets with the unique values found per</span>
<span class="sd">    cadence, lambda, and instrument in the carton, along with ``priority`` and ``value``</span>
<span class="sd">    ranges.</span>

<span class="sd">    Finally, function process_cartons wraps all the functions of this class. Based on the value</span>
<span class="sd">    of the ``origin`` parameter, takes as input a file from rsconfig or curstom, or takes a</span>
<span class="sd">    selection criteria to search cartons in targetdb. With this function we can evaluate the</span>
<span class="sd">    existence of a list of cartons, check their content, save a selection criteria as an input</span>
<span class="sd">    file ready to be used by process_cartons, runs assign_target_info to get target parameter</span>
<span class="sd">    set, ranges, and/or magnitude_placeholders, saves an output .csv file with the information</span>
<span class="sd">    of each carton, or return a list of all the CartonInfo objects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    carton: str</span>
<span class="sd">        Carton name in table targetdb.carton</span>
<span class="sd">    plan: str</span>
<span class="sd">        Plan in table targetdb.version</span>
<span class="sd">    category_label: str</span>
<span class="sd">        Label in targetdb.category table (e.g. science, standard_boss, guide)</span>
<span class="sd">    stage: str</span>
<span class="sd">        Robostrategy stage, could be srd, open, none, filler. Default is &#39;N/A&#39;</span>
<span class="sd">    active: str</span>
<span class="sd">        ``y`` or ``n`` to check if it is active in robostrategy. Default is &#39;N/A&#39;</span>
<span class="sd">    mapper_label: str</span>
<span class="sd">        Label in targetdb.mapper (MWM or BHM)</span>
<span class="sd">    program: str</span>
<span class="sd">        Program in targetdb.program table</span>
<span class="sd">    version_pk: int</span>
<span class="sd">        ID in targetdb.verion table</span>
<span class="sd">    tag: str</span>
<span class="sd">        tag in targetdb.version table</span>
<span class="sd">    mapper_pk: int</span>
<span class="sd">        Mapper_pk in targetdb.carton table. 0 for MWM and 1 for BHM</span>
<span class="sd">    category_pk: int</span>
<span class="sd">        category_pk in targetdb.carton table (e.g. 0 for science)</span>
<span class="sd">    in_targetdb: bool</span>
<span class="sd">        True is carton/plan/category_label combination is found in targetdb, false if not.</span>
<span class="sd">    sets_calculated: bool</span>
<span class="sd">        True when in_targetdb is True and target dependent parameters value_min, value_max,</span>
<span class="sd">        priority_min, priority_max, cadence_pk, cadence_label, lambda_eff, instrument_pk,</span>
<span class="sd">        and instrument_label have been calculated for the carton using</span>
<span class="sd">        assign_target_info(calculate_sets=True)</span>
<span class="sd">    mag_placeholders_calculated: bool</span>
<span class="sd">        True when magnitude placholdes used for SDSS, TMASS, and GAIA photometric systems</span>
<span class="sd">        have been calculated. These are calculated using check_magnitude_outliers function</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">cartons_inventory</span><span class="o">.</span><span class="n">config</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carton</span><span class="p">,</span> <span class="n">plan</span><span class="p">,</span> <span class="n">category_label</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="s1">&#39;N/A&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">carton</span> <span class="o">=</span> <span class="n">carton</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="n">plan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category_label</span> <span class="o">=</span> <span class="n">category_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">active</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mapper_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_pk</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_pk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_pk</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_targetdb</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sets_calculated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mag_placeholders_calculated</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assign_carton_info</span><span class="p">()</span>

<div class="viewcode-block" id="CartonInfo.assign_carton_info"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.CartonInfo.assign_carton_info">[docs]</a>    <span class="k">def</span> <span class="nf">assign_carton_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns carton dependent information for cartons in targetdb.</span>

<span class="sd">        If the carton/plan/category_label combination in the CartonInfo object</span>
<span class="sd">        is found in targetdb this function assigns attributes for carton dependent</span>
<span class="sd">        parameters (parameters shared for all targets in the carton). These paraemters</span>
<span class="sd">        are mapper_label, program, version_pk, tag, mapper_pk, and category_pk.</span>
<span class="sd">        Finally it set in_targetdb attribute as True when found in the database.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cfg</span> <span class="o">=</span> <span class="n">cartons_inventory</span><span class="o">.</span><span class="n">config</span>

        <span class="n">basic_info</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Car</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;mapper_label&#39;</span><span class="p">),</span> <span class="n">Car</span><span class="o">.</span><span class="n">version_pk</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;version_pk&#39;</span><span class="p">),</span>
                    <span class="n">Car</span><span class="o">.</span><span class="n">category_pk</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;category_pk&#39;</span><span class="p">),</span> <span class="n">Car</span><span class="o">.</span><span class="n">mapper_pk</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;mapper_pk&#39;</span><span class="p">),</span>
                    <span class="n">Version</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">Car</span><span class="o">.</span><span class="n">program</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Version</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">Version</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">Car</span><span class="o">.</span><span class="n">version_pk</span><span class="p">))</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Categ</span><span class="p">,</span> <span class="s1">&#39;LEFT JOIN&#39;</span><span class="p">,</span> <span class="n">Car</span><span class="o">.</span><span class="n">category_pk</span> <span class="o">==</span> <span class="n">Categ</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Map</span><span class="p">,</span> <span class="s1">&#39;LEFT JOIN&#39;</span><span class="p">,</span> <span class="n">Car</span><span class="o">.</span><span class="n">mapper_pk</span> <span class="o">==</span> <span class="n">Map</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Car</span><span class="o">.</span><span class="n">carton</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">carton</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Version</span><span class="o">.</span><span class="n">plan</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Categ</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_label</span><span class="p">)</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">basic_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># If the carton is in targetdb assigns carton info</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">basic_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">carton_parameter_names</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;db_fields&#39;</span><span class="p">][</span><span class="s1">&#39;carton_dependent&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">carton_parameter_names</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="n">parameter</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_targetdb</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_targetdb</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># If not in targetdb still tries to get the Version info</span>
            <span class="n">query_version</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Version</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Version</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">Version</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Version</span><span class="o">.</span><span class="n">plan</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_version</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ver_info</span> <span class="o">=</span> <span class="n">query_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">ver_info</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version_pk</span> <span class="o">=</span> <span class="n">ver_info</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="CartonInfo.build_query_target"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.CartonInfo.build_query_target">[docs]</a>    <span class="k">def</span> <span class="nf">build_query_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates the query with the target dependet information of the carton.&quot;&quot;&quot;</span>

        <span class="n">query_target</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Car</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Inst</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;instrument_label&#39;</span><span class="p">),</span> <span class="n">CarTar</span><span class="o">.</span><span class="n">cadence_pk</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;cadence_pk&#39;</span><span class="p">),</span>
                    <span class="n">CarTar</span><span class="o">.</span><span class="n">lambda_eff</span><span class="p">,</span> <span class="n">CarTar</span><span class="o">.</span><span class="n">instrument_pk</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;instrument_pk&#39;</span><span class="p">),</span>
                    <span class="n">CarTar</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">CarTar</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Cad</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;cadence_label&#39;</span><span class="p">),</span> <span class="n">Mag</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">Mag</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
                    <span class="n">Mag</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">Mag</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">Mag</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">Mag</span><span class="o">.</span><span class="n">j</span><span class="p">,</span> <span class="n">Mag</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">Mag</span><span class="o">.</span><span class="n">bp</span><span class="p">,</span> <span class="n">Mag</span><span class="o">.</span><span class="n">rp</span><span class="p">,</span> <span class="n">Mag</span><span class="o">.</span><span class="n">gaia_g</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Version</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">Version</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">Car</span><span class="o">.</span><span class="n">version_pk</span><span class="p">))</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CarTar</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">CarTar</span><span class="o">.</span><span class="n">carton_pk</span> <span class="o">==</span> <span class="n">Car</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Cad</span><span class="p">,</span> <span class="s1">&#39;LEFT JOIN&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">Cad</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">CarTar</span><span class="o">.</span><span class="n">cadence_pk</span><span class="p">))</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Inst</span><span class="p">,</span> <span class="s1">&#39;LEFT JOIN&#39;</span><span class="p">,</span> <span class="n">CarTar</span><span class="o">.</span><span class="n">instrument_pk</span> <span class="o">==</span> <span class="n">Inst</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Mag</span><span class="p">,</span> <span class="s1">&#39;LEFT JOIN&#39;</span><span class="p">,</span> <span class="n">CarTar</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">Mag</span><span class="o">.</span><span class="n">carton_to_target_pk</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Car</span><span class="o">.</span><span class="n">carton</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">carton</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">Version</span><span class="o">.</span><span class="n">plan</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Version</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">query_target</span></div>

<div class="viewcode-block" id="CartonInfo.return_target_dataframe"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.CartonInfo.return_target_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">return_target_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Executes query from build_query_target and returns it in a Pandas DataFrame.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_targetdb</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">carton</span><span class="p">,</span> <span class="s1">&#39;not in targetdb so we cant return the target dataframe&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">target_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_query_target</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">target_query</span><span class="o">.</span><span class="n">dicts</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="CartonInfo.assign_target_info"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.CartonInfo.assign_target_info">[docs]</a>    <span class="k">def</span> <span class="nf">assign_target_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calculate_sets</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">calculate_mag_placeholders</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assignt target dependent information for cartons in targetdb.</span>

<span class="sd">        This function calls return_target_dataframe to get a Pandas DataFrame</span>
<span class="sd">        with target dependent information for a carton. Then it sets different attributes</span>
<span class="sd">        to the CartonInfo object depending on the values of calculate_sets and</span>
<span class="sd">        calculate_mag_placeholders</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        calculate_sets : bool</span>
<span class="sd">            If true this function assigns the attributes value_min, value_max,</span>
<span class="sd">            priority_min, priority_max, cadence_pk, cadence_label, lambda_eff, instrument_pk,</span>
<span class="sd">            and instrument_label, based on information from targetdb. It also sets the attribute</span>
<span class="sd">            sets_calculated as True to keep record.</span>
<span class="sd">        calculate_mag_placeholders : bool</span>
<span class="sd">            If true this function assigns the attribute magnitude_placeholders using</span>
<span class="sd">            check_mag_outliers function, and sets mag_placeholers_calculated=True to keep record.</span>
<span class="sd">            magnitude_placeholres is a set with all the combination of photometric system</span>
<span class="sd">            (SDSS, TMASS, GAIA) and mag placeholder used for that photometric system in that</span>
<span class="sd">            carton (None, Invalid, 0.0, -9999.0, 999, 99.9).</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataframe_created</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_targetdb</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;carton&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">carton</span><span class="p">,</span> <span class="s1">&#39;version_pk&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_pk</span><span class="p">,</span>
                  <span class="s1">&#39;category_label&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_label</span><span class="p">,</span> <span class="s1">&#39;not found in database&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;so we cant assign target info&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">calculate_sets</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sets_calculated</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sets already calculated for this carton&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_target_dataframe</span><span class="p">()</span>
                <span class="n">dataframe_created</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">target_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;db_fields&#39;</span><span class="p">]</span>
                <span class="n">set_names</span> <span class="o">=</span> <span class="n">target_parameters</span><span class="p">[</span><span class="s1">&#39;sets&#39;</span><span class="p">]</span>
                <span class="n">set_range_names</span> <span class="o">=</span> <span class="n">target_parameters</span><span class="p">[</span><span class="s1">&#39;set_ranges&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="n">set_names</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_name</span><span class="p">,</span> <span class="n">main</span><span class="o">.</span><span class="n">set_or_none</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="n">set_name</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="n">set_range_names</span><span class="p">:</span>
                    <span class="n">set_range</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">get_range</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_name</span><span class="p">))</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_name</span> <span class="o">+</span> <span class="s1">&#39;_min&#39;</span><span class="p">,</span> <span class="n">set_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_name</span> <span class="o">+</span> <span class="s1">&#39;_max&#39;</span><span class="p">,</span> <span class="n">set_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sets_calculated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">calculate_mag_placeholders</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_placeholders_calculated</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Magnitude placeholders already caclulated for this carton&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dataframe_created</span><span class="p">:</span>
                    <span class="n">dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_target_dataframe</span><span class="p">()</span>
                    <span class="n">dataframe_created</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">bands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span>
                <span class="n">mags_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bands</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
                <span class="n">systems_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bands</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">magnitude_placeholders</span> <span class="o">=</span> <span class="n">check_mag_outliers</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">mags_names</span><span class="p">,</span>
                                                                 <span class="n">systems_names</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mag_placeholders_calculated</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CartonInfo.check_existence"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.CartonInfo.check_existence">[docs]</a>    <span class="k">def</span> <span class="nf">check_existence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if the carton/plan/category_label from object is found in targetdb.</span>

<span class="sd">        This function checks whether a carton exists or not in targetdb, to be used</span>
<span class="sd">        when a list of cartons is used in process_cartons (i.e. ``origin`` rsconfig or custom)</span>
<span class="sd">        or to check the existence of a single carton.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        log : SDSSLogger</span>
<span class="sd">            Log used to store information of cartons_inventory</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            If true and if the carton is not found in the database the function will print</span>
<span class="sd">            and save on log information to try to correct the input file from which the</span>
<span class="sd">            carton/plan/category_label was taken (and stored in the object). If no carton</span>
<span class="sd">            with that name is found in targetdb it will print the associated warning, and if</span>
<span class="sd">            cartons with the same name but different plan or category_label are found a line</span>
<span class="sd">            with input file format will be printed for each of those cartons so the user</span>
<span class="sd">            can replace the line in the input file with one of the options proposed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        cartons_aleternatives : Pandas DataFrame</span>
<span class="sd">            A Pandas DataFrame that for each carton/plan/category_label combination not found</span>
<span class="sd">            in targetdb has an entry for it and for all the alternative cartons found in targetdb</span>
<span class="sd">            that have the same carton name but different plan or category. For each entry the</span>
<span class="sd">            dataframe contains the columns carton, plan, category_label, stage, active, tag,</span>
<span class="sd">            version_pk, and in_targetdb.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_targetdb</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;carton&#39;</span><span class="p">,</span> <span class="s1">&#39;plan&#39;</span><span class="p">,</span> <span class="s1">&#39;category_label&#39;</span><span class="p">,</span> <span class="s1">&#39;stage&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;version_pk&#39;</span><span class="p">,</span> <span class="s1">&#39;in_targetdb&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)):</span>
                <span class="n">colname</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="nb">locals</span><span class="p">()[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="nb">locals</span><span class="p">()[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colname</span><span class="p">))</span>

            <span class="n">alternatives_info</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Car</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Car</span><span class="o">.</span><span class="n">carton</span><span class="p">,</span> <span class="n">Version</span><span class="o">.</span><span class="n">plan</span><span class="p">,</span> <span class="n">Car</span><span class="o">.</span><span class="n">version_pk</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;version_pk&#39;</span><span class="p">),</span>
                        <span class="n">Categ</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;category_label&#39;</span><span class="p">),</span> <span class="n">Version</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">Car</span><span class="o">.</span><span class="n">program</span><span class="p">)</span>
                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Version</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">Version</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">Car</span><span class="o">.</span><span class="n">version_pk</span><span class="p">))</span>
                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Categ</span><span class="p">,</span> <span class="s1">&#39;LEFT JOIN&#39;</span><span class="p">,</span> <span class="n">Car</span><span class="o">.</span><span class="n">category_pk</span> <span class="o">==</span> <span class="n">Categ</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Car</span><span class="o">.</span><span class="n">carton</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">carton</span><span class="p">)</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternatives_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Wargning: Carton&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">carton</span> <span class="o">+</span> <span class="s1">&#39; not in targetdb&#39;</span>\
                    <span class="s1">&#39;not in targetdb and there is no carton with that name&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Carton &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">carton</span> <span class="o">+</span> <span class="s1">&#39; not in targetdb, to avoid this you can replace &#39;</span>\
                    <span class="s1">&#39;the next</span><span class="se">\n</span><span class="s1">line with the information that follows &#39;</span>\
                    <span class="s1">&#39;replacing (stage) and (active) if it corresponds</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">carton</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; | &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; | &#39;</span>\
                       <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_label</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; |&#39;</span>\
                       <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; | &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; | &#39;</span>\
                       <span class="o">+</span> <span class="s1">&#39;--&gt; Replace this line</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alternatives_info</span><span class="p">)):</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">alternatives_info</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span>
                    <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="nb">locals</span><span class="p">()[</span><span class="n">colname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">colname</span><span class="p">])</span>
                    <span class="nb">locals</span><span class="p">()[</span><span class="s1">&#39;in_targetdb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;carton&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; | &#39;</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;plan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; | &#39;</span>\
                        <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;category_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; |   N/A |    N/A |</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)):</span>
                <span class="n">df_data</span><span class="p">[</span><span class="n">colnames</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">colnames</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">msg</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="CartonInfo.visualize_content"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.CartonInfo.visualize_content">[docs]</a>    <span class="k">def</span> <span class="nf">visualize_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">140</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Logs and prints information from targetdb for a given carton.&quot;&quot;&quot;</span>

        <span class="n">pars</span> <span class="o">=</span> <span class="n">cartons_inventory</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_fields&#39;</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
        <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;CARTON DEPENDENT INFORMATION&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
        <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;carton&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;input_dependent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;in_targetdb&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_param</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;carton_dependent&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_param</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_targetdb</span><span class="p">:</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;Since the carton is not in targetdb&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;this is all the information we can get&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sets_calculated</span><span class="p">):</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;The list of values par target parameter has&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;not been calculated for this carton, to do so&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;first run assign_target_info on this carton&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;using calculate_sets=True (default)&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;VALUES PER TARGET DEPENDENT PARAMETER&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sets&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">el</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;set_ranges&#39;</span><span class="p">]]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_param</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;set_ranges&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_range</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_placeholders_calculated</span><span class="p">):</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;The list of mag placeholers for each photometric&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;system has not been calculated for this carton yet,&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;to do so first run assign_target_info on this carton&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;using calculate_mag_placeholers=True (not default)&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;MAGNITUDE PLACEHOLDERS PER PHOTOMETRIC SYSTEM&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_param</span><span class="p">(</span><span class="s1">&#39;magnitude_placeholders&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span></div>

<div class="viewcode-block" id="CartonInfo.print_param"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.CartonInfo.print_param">[docs]</a>    <span class="k">def</span> <span class="nf">print_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;logs a message with width=width containing a parameter from carton object.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;### &#39;</span> <span class="o">+</span> <span class="n">par</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span>
                 <span class="s1">&#39; ###&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CartonInfo.print_range"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.CartonInfo.print_range">[docs]</a>    <span class="k">def</span> <span class="nf">print_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;logs a message with width=width containing the range of a parameter from the carton.&quot;&quot;&quot;</span>
        <span class="n">left_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span> <span class="o">+</span> <span class="s1">&#39;_min&#39;</span><span class="p">))</span>
        <span class="n">right_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par</span> <span class="o">+</span> <span class="s1">&#39;_max&#39;</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;### &#39;</span> <span class="o">+</span> <span class="n">par</span> <span class="o">+</span> <span class="s1">&#39; range: &#39;</span> <span class="o">+</span> <span class="n">left_msg</span> <span class="o">+</span> <span class="s1">&#39; to &#39;</span> <span class="o">+</span> <span class="n">right_msg</span> <span class="o">+</span>
                 <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_msg</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_msg</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; ###&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="print_centered_msg"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.print_centered_msg">[docs]</a><span class="k">def</span> <span class="nf">print_centered_msg</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Logs and prints string st with width=width in the log&quot;&quot;&quot;</span>
    <span class="n">left</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">-</span> <span class="n">left</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;###&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">left</span> <span class="o">+</span> <span class="n">st</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">right</span> <span class="o">+</span> <span class="s1">&#39; ###&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="gets_carton_info"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.gets_carton_info">[docs]</a><span class="k">def</span> <span class="nf">gets_carton_info</span><span class="p">(</span><span class="n">carton_list_filename</span><span class="p">,</span> <span class="n">header_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the necessary information from the input carton list file.&quot;&quot;&quot;</span>

    <span class="n">cat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">carton_list_filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;str&#39;</span><span class="p">,</span>
                     <span class="n">skiprows</span><span class="o">=</span><span class="n">header_length</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">)</span>
    <span class="n">cartons</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">))]</span>
    <span class="n">plans</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">))]</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">))]</span>
    <span class="n">stages</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">))]</span>
    <span class="n">actives</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">cartons</span><span class="p">,</span> <span class="n">plans</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">stages</span><span class="p">,</span> <span class="n">actives</span></div>


<div class="viewcode-block" id="check_mag_outliers"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.check_mag_outliers">[docs]</a><span class="k">def</span> <span class="nf">check_mag_outliers</span><span class="p">(</span><span class="n">datafr</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">systems</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a list with all the types of outliers found for each photometric system.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datafr : Pandas DataFrame</span>
<span class="sd">        Containing the magnitudes from different photometric systems for the stars in a</span>
<span class="sd">        given carton.</span>
<span class="sd">    bands : strings list</span>
<span class="sd">        Containing the bands to search each belonging to a given photometric system.</span>
<span class="sd">    system : strings list</span>
<span class="sd">        Photometric system to which each band listed belongs to. The options are</span>
<span class="sd">        &#39;SDSS&#39;, &#39;TMASS&#39;, and &#39;GAIA&#39;. The system to which a band belongs is defined by the</span>
<span class="sd">        index of the band in the list (i.e. band[ind] belongs to systems[ind])</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    placeholders : set</span>
<span class="sd">        A set of strings where each string starts with the photometric system,</span>
<span class="sd">        then an underscore and finally the type of magnitude outlier that at least one</span>
<span class="sd">        magnitude of the corresponding system has.</span>
<span class="sd">        The type of outliers are: None (For empty entries), Invalid (For Nan&#39;s and</span>
<span class="sd">        infinite values), and &lt;&lt;Number&gt;&gt; (For values brighter than -9, dimmer than 50,</span>
<span class="sd">        or equal to zero), in the latter cases the number itself is returned as the outlier type.</span>

<span class="sd">        For example if a carton contains stars with h=999.9, k=999.9, j=None, and bp=Inf.</span>
<span class="sd">        This function will return {&#39;TMASS_999.9&#39;, &#39;TMASS_None&#39;, &#39;GAIA_Invalid}.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_bands</span><span class="p">,</span> <span class="n">out_systems</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ind_band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)):</span>
        <span class="n">maglist</span> <span class="o">=</span> <span class="n">datafr</span><span class="p">[</span><span class="n">bands</span><span class="p">[</span><span class="n">ind_band</span><span class="p">]]</span>
        <span class="n">nonempty_maglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">maglist</span> <span class="k">if</span> <span class="n">el</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">magarr_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nonempty_maglist</span><span class="p">)</span>
        <span class="n">ind_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">magarr_filled</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">magarr_valid</span> <span class="o">=</span> <span class="n">magarr_filled</span><span class="p">[</span><span class="n">ind_valid</span><span class="p">]</span>
        <span class="n">ind_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">magarr_valid</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">magarr_valid</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">magarr_valid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">out_band</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">magarr_valid</span><span class="p">[</span><span class="n">indice</span><span class="p">])</span> <span class="k">for</span> <span class="n">indice</span> <span class="ow">in</span> <span class="n">ind_out</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">maglist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonempty_maglist</span><span class="p">):</span>
            <span class="n">out_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">magarr_filled</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">magarr_valid</span><span class="p">):</span>
            <span class="n">out_band</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
        <span class="n">n_out</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_band</span><span class="p">)</span>
        <span class="n">out_bands</span> <span class="o">=</span> <span class="n">out_bands</span> <span class="o">+</span> <span class="n">out_band</span>
        <span class="n">out_systems</span> <span class="o">=</span> <span class="n">out_systems</span> <span class="o">+</span> <span class="p">[</span><span class="n">systems</span><span class="p">[</span><span class="n">ind_band</span><span class="p">]]</span> <span class="o">*</span> <span class="n">n_out</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">set_or_none</span><span class="p">([</span><span class="n">out_systems</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">out_bands</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                           <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_bands</span><span class="p">))])</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="process_cartons"><a class="viewcode-back" href="../../api.html#cartons_inventory.cartons.process_cartons">[docs]</a><span class="k">def</span> <span class="nf">process_cartons</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;rsconfig&#39;</span><span class="p">,</span> <span class="n">files_folder</span><span class="o">=</span><span class="s1">&#39;./files/&#39;</span><span class="p">,</span> <span class="n">inputname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">delim</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">check_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_objects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">write_input</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assign_sets</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">assign_placeholders</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">all_cartons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cartons_name_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">versions</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">,</span>
                    <span class="n">forced_versions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unique_version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get targetdb information for list of cartons or selection criteria and outputs .csv file.</span>

<span class="sd">    Takes as input a file with a list of cartons from rsconfig (origin=``rsconfig``)</span>
<span class="sd">    or custom (origin=``custom``) or a selection criteria to be applied on targetdb</span>
<span class="sd">    (origin=``targetdb) in which case an input list file can also be created</span>
<span class="sd">    (with write_input=True) for future use.</span>

<span class="sd">    This function can be used to check the existence of the cartons (check_exist=True)</span>
<span class="sd">    in which case it returns a dataframe with the alternative cartons information, or</span>
<span class="sd">    it can be used to call assign_target_info to get the targetdb information of all</span>
<span class="sd">    the cartons (check_exists=False) and store it in a .csv file and/or return the</span>
<span class="sd">    CartonInfo objects.</span>

<span class="sd">    The function also has provides the option of logging and printing the targetdb information</span>
<span class="sd">    from all the cartons in a human readable way by using visualize=True.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    origin : str</span>
<span class="sd">        ``rsconfig`` to use input list file from rsconfig, ``custom`` to use custom input list</span>
<span class="sd">        of carton or ``targetdb`` to look for cartons in targetdb based on the ``all_cartons``,</span>
<span class="sd">        ``cartons_name_pattern``, ``versions``, ``forced_versions``, and ``unique_versions``</span>
<span class="sd">        parameters.</span>
<span class="sd">    files_folder : str</span>
<span class="sd">        Main folder where input and output files would be stored. In this folder subfolders</span>
<span class="sd">        rsconfig, custom, and targetdb are expected.</span>
<span class="sd">    inputname : str or None</span>
<span class="sd">        Name of input file to be searched in &lt;&lt;files_folder&gt;&gt;/&lt;&lt;origin&gt;&gt; folder</span>
<span class="sd">    delim : str</span>
<span class="sd">        Delimiter character to use when creating output .csv file</span>
<span class="sd">    check_exists : bool</span>
<span class="sd">        If true and origin is rsconfig or custom the function looks for alternatives to cartons</span>
<span class="sd">        that exist in targetdb but have different values of plan or category_label than carton</span>
<span class="sd">        object. In this case the function returns a dataframe with the original carton versions</span>
<span class="sd">        not found and the alternatives and exits the function</span>
<span class="sd">    verb : bool</span>
<span class="sd">        If True function logs and prints alternatives to replace the input lines</span>
<span class="sd">        corresponding to carton/plan/category_label combinations not found in targetdb with lines</span>
<span class="sd">        corresponding to the same carton but with existing plan/category_label combinations.</span>
<span class="sd">    return_objects : bool</span>
<span class="sd">        If True the function returns the CartonInfo objects.</span>
<span class="sd">    write_input : bool</span>
<span class="sd">        If True the function writes a file to be used then as input by</span>
<span class="sd">        process_cartons with the cartons retrieved by the targetdb query.</span>
<span class="sd">    write_output : bool</span>
<span class="sd">        If True the function creates an output .csv file with the</span>
<span class="sd">        information of each CartonInfo object.</span>
<span class="sd">    assign_sets : bool</span>
<span class="sd">        If True assign_target_info assigns the attributes for target dependent parameters for the</span>
<span class="sd">        carton. For each parameter returns a python set with all the values present in the carton</span>
<span class="sd">        targets or the range spanned by them.</span>
<span class="sd">    assign_placeholders : bool</span>
<span class="sd">        If True assign_target_info assigns magnitude placeholders found in targetdb for each</span>
<span class="sd">        photometric system (SDSS, TMASS, GAIA) for each carton using check_mag_outliers.</span>
<span class="sd">    visualize : bool</span>
<span class="sd">        If True we log and print all the information found in targetdb for each carton in a human</span>
<span class="sd">        readable way</span>
<span class="sd">    overwrite : bool</span>
<span class="sd">        If True enables that inputfile like and output file could be overwritten.</span>
<span class="sd">    all_cartons : bool</span>
<span class="sd">        If True and origin=targetdb cartons with any name are taken from targetdb.</span>
<span class="sd">        from targetdb</span>
<span class="sd">    cartons_name_pattern : str or None</span>
<span class="sd">        If True and origin=targetdb only cartons with pattern name cartons_name_pattern are</span>
<span class="sd">        are taken from targetdb. The string uses * character as wildcard </span>
<span class="sd">    versions : str</span>
<span class="sd">        If True and origin=targetdb sets the versions that would be taken for each carton name</span>
<span class="sd">        If ``single`` only versions matching ``unique_version`` will be taken, if ``latest``</span>
<span class="sd">        only the latest version of each carton would be taken, if ``all`` all versions from each</span>
<span class="sd">        carton is taken.</span>
<span class="sd">    forced_versions: dict or None</span>
<span class="sd">        If present, and origin=targetdb all cartons in this dictionary are forced to consider</span>
<span class="sd">        only the version in the dictionary corresponding value, independent on the ``versions``</span>
<span class="sd">        value.</span>
<span class="sd">    unique_version : Int or None</span>
<span class="sd">        If present, origin=targetdb, and versions=single then only this version_pk will be</span>
<span class="sd">        considered for each carton</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">cartons_inventory</span><span class="o">.</span><span class="n">config</span>
    <span class="c1"># Check that we have a valid origin parameter</span>
    <span class="k">assert</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;targetdb&#39;</span><span class="p">,</span> <span class="s1">&#39;rsconfig&#39;</span><span class="p">,</span> <span class="s1">&#39;custom&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">origin</span><span class="si">!r}</span><span class="s1"> is not a valid&#39;</span>\
        <span class="s1">&#39; option for origin parameter&#39;</span>

    <span class="n">fullfolder</span> <span class="o">=</span> <span class="n">files_folder</span> <span class="o">+</span> <span class="n">origin</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

    <span class="c1"># If an input file is used check that it exists and that we are not trying to overwrite it</span>
    <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rsconfig&#39;</span><span class="p">,</span> <span class="s1">&#39;custom&#39;</span><span class="p">]:</span>

        <span class="k">assert</span> <span class="n">write_input</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;write_input=True only available for origin=</span><span class="se">\&#39;</span><span class="s1">targetdb</span><span class="se">\&#39;</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="n">inputname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;for origin=</span><span class="si">{</span><span class="n">origin</span><span class="si">!r}</span><span class="s1"> an inputname has to be provided&#39;</span>
        <span class="n">inputread_filename</span> <span class="o">=</span> <span class="n">fullfolder</span> <span class="o">+</span> <span class="n">inputname</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">inputread_filename</span><span class="p">),</span> <span class="s1">&#39;file: &#39;</span> <span class="o">+</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">inputread_filename</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; required for origin=</span><span class="si">{</span><span class="n">origin</span><span class="si">!r}</span><span class="s1">&#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;and inputname=</span><span class="si">{</span><span class="n">inputname</span><span class="si">!r}</span><span class="s1"> but file doesn</span><span class="se">\&#39;</span><span class="s1">t exist&#39;</span>

        <span class="n">outputbase_filename</span> <span class="o">=</span> <span class="n">fullfolder</span> <span class="o">+</span> <span class="s1">&#39;Info_&#39;</span> <span class="o">+</span> <span class="n">inputname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;targetdb&#39;</span><span class="p">:</span>

        <span class="c1"># First check if the input arguments are valid</span>
        <span class="k">assert</span> <span class="n">check_exists</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;check_exists=True option only valid for origin&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">rsconfig</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">custom</span><span class="se">\&#39;</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="n">versions</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;latest&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">versions</span><span class="si">!r}</span><span class="s1"> is not a valid option&#39;</span>\
            <span class="s1">&#39; for versions parameter&#39;</span>
        <span class="k">assert</span> <span class="n">forced_versions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">forced_versions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">,</span> <span class="s1">&#39;if used, &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;forced_versions has to be type=dict not type=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">forced_versions</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">assert</span> <span class="n">all_cartons</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">cartons_name_pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39; carton_name_pattern&#39;</span>\
            <span class="s1">&#39; needed when all_cartons=False (e.g. cartons_name_pattern=</span><span class="se">\&#39;</span><span class="s1">bhm_rm_*</span><span class="se">\&#39;</span><span class="s1">)&#39;</span>
        <span class="k">assert</span> <span class="n">versions</span> <span class="o">!=</span> <span class="s1">&#39;single&#39;</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">unique_version</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;If versions=</span><span class="se">\&#39;</span><span class="s1">single</span><span class="se">\&#39;</span><span class="s1"> then&#39;</span>\
            <span class="s1">&#39; unique version has to be an integer&#39;</span>
        <span class="k">assert</span> <span class="n">write_input</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">write_output</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;To create an output file&#39;</span>\
            <span class="s1">&#39; an input file has to be created as well to help keep record&#39;</span>

        <span class="c1"># Then I calculate the base name for input and output files based on selection criteria</span>
        <span class="k">if</span> <span class="n">all_cartons</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="s1">&#39;Cartons_all&#39;</span>
        <span class="k">if</span> <span class="n">all_cartons</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="s1">&#39;Cartons_sample&#39;</span>
        <span class="k">if</span> <span class="n">versions</span> <span class="o">!=</span> <span class="s1">&#39;unique&#39;</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">+=</span> <span class="s1">&#39;_Versions_&#39;</span> <span class="o">+</span> <span class="n">versions</span>
        <span class="k">if</span> <span class="n">versions</span> <span class="o">==</span> <span class="s1">&#39;unique&#39;</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">+=</span> <span class="s1">&#39;_Version_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_version</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">forced_versions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">+=</span> <span class="s1">&#39;_and_forced&#39;</span>

        <span class="n">inputwrite_filename</span> <span class="o">=</span> <span class="n">fullfolder</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
        <span class="n">outputbase_filename</span> <span class="o">=</span> <span class="n">fullfolder</span> <span class="o">+</span> <span class="s1">&#39;Info_&#39;</span> <span class="o">+</span> <span class="n">basename</span>

        <span class="k">if</span> <span class="n">write_input</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">inputwrite_filename</span><span class="p">),</span> <span class="s1">&#39;input file &#39;</span>\
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">inputwrite_filename</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1"> already exists and overwrite=False&#39;</span>

    <span class="c1"># If write_output set the final output_filename and check overwritting</span>
    <span class="k">if</span> <span class="n">write_output</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">assign_sets</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">assign_placeholders</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;to create an output .csv&#39;</span>\
            <span class="s1">&#39;at least one of assign_sets or assign_placeholders has to be True&#39;</span>
        <span class="k">if</span> <span class="n">assign_sets</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">assign_placeholders</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">output_filename</span> <span class="o">=</span> <span class="n">outputbase_filename</span> <span class="o">+</span> <span class="s1">&#39;_sets.csv&#39;</span>
        <span class="k">if</span> <span class="n">assign_sets</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">assign_placeholders</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output_filename</span> <span class="o">=</span> <span class="n">outputbase_filename</span> <span class="o">+</span> <span class="s1">&#39;_magplaceholers.csv&#39;</span>
        <span class="k">if</span> <span class="n">assign_sets</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">assign_placeholders</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output_filename</span> <span class="o">=</span> <span class="n">outputbase_filename</span> <span class="o">+</span> <span class="s1">&#39;_all.csv&#39;</span>

        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">output_filename</span><span class="p">),</span> <span class="s1">&#39;output file &#39;</span>\
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1"> already exists and overwrite=False&#39;</span>

    <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rsconfig&#39;</span><span class="p">,</span> <span class="s1">&#39;custom&#39;</span><span class="p">]:</span>
        <span class="n">cartons</span><span class="p">,</span> <span class="n">plans</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">stages</span><span class="p">,</span> <span class="n">actives</span> <span class="o">=</span> <span class="n">gets_carton_info</span><span class="p">(</span><span class="n">inputread_filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;targetdb&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">all_cartons</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">all_cartons</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">cartons_name_pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>

        <span class="n">cartons_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Car</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Car</span><span class="o">.</span><span class="n">carton</span><span class="p">,</span> <span class="n">Version</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;version_pk&#39;</span><span class="p">),</span> <span class="n">Version</span><span class="o">.</span><span class="n">plan</span><span class="p">,</span>
                    <span class="n">Categ</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;category_label&#39;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Version</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">Version</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">Car</span><span class="o">.</span><span class="n">version_pk</span><span class="p">))</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Categ</span><span class="p">,</span> <span class="s1">&#39;LEFT JOIN&#39;</span><span class="p">,</span> <span class="n">Car</span><span class="o">.</span><span class="n">category_pk</span> <span class="o">==</span> <span class="n">Categ</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Car</span><span class="o">.</span><span class="n">carton</span> <span class="o">**</span> <span class="n">pattern</span><span class="p">)</span>
            <span class="o">.</span><span class="n">dicts</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># Here we look for the basic information of each carton/plan/category_label</span>
        <span class="c1"># available in targetdb to then instantiate the objects with that information</span>
        <span class="c1"># For each carton name we calculate the version_pk(s) that match the selection criteria</span>
        <span class="c1"># according to the value of ``versions`` parameter (single, all, latest) and override</span>
        <span class="c1"># the value if carton is present in forced_versions dictionary.</span>
        <span class="n">cart_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cartons_list</span><span class="p">)</span>
        <span class="n">cartons_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cart_results</span><span class="p">[</span><span class="s1">&#39;carton&#39;</span><span class="p">])))</span>
        <span class="n">all_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cartons_unique</span><span class="p">:</span>
            <span class="n">indcart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cart_results</span><span class="p">[</span><span class="s1">&#39;carton&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">forced_versions</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">forced_versions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">cart_results</span><span class="p">[</span><span class="s1">&#39;carton&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="n">cart_results</span><span class="p">[</span><span class="s1">&#39;version_pk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">forced_versions</span><span class="p">[</span><span class="n">name</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">versions</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
                <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">cart_results</span><span class="p">[</span><span class="s1">&#39;carton&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="n">cart_results</span><span class="p">[</span><span class="s1">&#39;version_pk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">unique_version</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">versions</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">inds</span> <span class="o">=</span> <span class="n">indcart</span>
            <span class="k">elif</span> <span class="n">versions</span> <span class="o">==</span> <span class="s1">&#39;latest&#39;</span><span class="p">:</span>
                <span class="n">max_version</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cart_results</span><span class="p">[</span><span class="s1">&#39;version_pk&#39;</span><span class="p">][</span><span class="n">indcart</span><span class="p">])</span>
                <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">cart_results</span><span class="p">[</span><span class="s1">&#39;carton&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="n">cart_results</span><span class="p">[</span><span class="s1">&#39;version_pk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_version</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">all_indices</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;There are no carton/version_pk pairs matching the selection&#39;</span>\
            <span class="s1">&#39; criteria used&#39;</span>
        <span class="n">carts_sel</span> <span class="o">=</span> <span class="n">cart_results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">all_indices</span><span class="p">]</span>
        <span class="n">cartons</span> <span class="o">=</span> <span class="n">carts_sel</span><span class="p">[</span><span class="s1">&#39;carton&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">plans</span> <span class="o">=</span> <span class="n">carts_sel</span><span class="p">[</span><span class="s1">&#39;plan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="n">carts_sel</span><span class="p">[</span><span class="s1">&#39;category_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">stages</span><span class="p">,</span> <span class="n">actives</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;N/A&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">carts_sel</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;N/A&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">carts_sel</span><span class="p">)</span>

    <span class="c1"># Here we start the corresponding log based on the origin, assign_sets,</span>
    <span class="c1"># and assign_placeholders value</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./logs/origin_</span><span class="si">{</span><span class="n">origin</span><span class="si">}</span><span class="s1">_sets_</span><span class="si">{</span><span class="n">assign_sets</span><span class="si">}</span><span class="s1">_mags_</span><span class="si">{</span><span class="n">assign_placeholders</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">start_file_logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./logs/origin_</span><span class="si">{</span><span class="n">origin</span><span class="si">}</span><span class="s1">_sets_</span><span class="si">{</span><span class="n">assign_sets</span><span class="si">}</span><span class="s1">&#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;_mags_</span><span class="si">{</span><span class="n">assign_placeholders</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">print_centered_msg</span><span class="p">(</span><span class="s1">&#39;STARTING CODE EXECUTION&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ran process_cartons using the following arguments&#39;</span><span class="p">)</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">process_cartons</span><span class="p">)</span>
    <span class="c1"># First thing we log is the parameters used in process_cartons function</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">param</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="c1"># Here we write an input-like file if requested</span>
    <span class="k">if</span> <span class="n">origin</span> <span class="o">==</span> <span class="s1">&#39;targetdb&#39;</span> <span class="ow">and</span> <span class="n">write_input</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">cartons</span><span class="p">,</span> <span class="n">plans</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">stages</span><span class="p">,</span> <span class="n">actives</span><span class="p">])</span>
        <span class="n">ascii</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">inputwrite_filename</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fixed_width&#39;</span><span class="p">,</span>
                    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;carton&#39;</span><span class="p">,</span> <span class="s1">&#39;plan&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;stage&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">],</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrote file </span><span class="si">{</span><span class="n">inputwrite_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># If write_output then we prepare the .csv writer</span>
    <span class="k">if</span> <span class="n">write_output</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;db_fields&#39;</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delim</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;carton&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;input_dependent&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;carton_dependent&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">assign_sets</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">new_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;sets&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;set_ranges&#39;</span><span class="p">]]</span>
            <span class="n">columns</span> <span class="o">+=</span> <span class="n">new_cols</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;set_ranges&#39;</span><span class="p">]:</span>
                <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_min&#39;</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_max&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">assign_placeholders</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;magnitude_placeholders&#39;</span><span class="p">]</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Here we start the actual processing of the cartons</span>
    <span class="n">objects</span><span class="p">,</span> <span class="n">diffs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cartons</span><span class="p">)):</span>

        <span class="c1"># First we instantiate the CartonInfo objects with the information we have</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">CartonInfo</span><span class="p">(</span><span class="n">cartons</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">plans</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">categories</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                         <span class="n">stages</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">actives</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="c1"># If check_exists we run check_existence on the cartons and return the diff dataframe</span>
        <span class="k">if</span> <span class="n">check_exists</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">check_existence</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cartons</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ran check_existence to compare input file &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">inputname</span><span class="si">}</span><span class="s1"> with targetdb content&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">output</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">in_targetdb</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;carton=</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">carton</span><span class="si">}</span><span class="s1"> plan=</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">plan</span><span class="si">}</span><span class="s1"> version_pk=</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">version_pk</span><span class="si">}</span><span class="s1">&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;category=</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">category_label</span><span class="si">}</span><span class="s1"> not found in targetdb&#39;</span><span class="p">)</span>
        <span class="c1"># Here we assign sets and or mag placeholders info based on input arguments</span>
        <span class="c1"># And we visualize and write in output .csv if it corresponds</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">in_targetdb</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">assign_target_info</span><span class="p">(</span><span class="n">calculate_sets</span><span class="o">=</span><span class="n">assign_sets</span><span class="p">,</span>
                                   <span class="n">calculate_mag_placeholders</span><span class="o">=</span><span class="n">assign_placeholders</span><span class="p">)</span>
            <span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ran assign_target_info on carton </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">carton</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">visualize</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">visualize_content</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">write_output</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">curr_info</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">curr_info</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wrote row to output csv for carton=</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">carton</span><span class="si">}</span><span class="s1">&#39;</span>
                         <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cartons</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">write_output</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved output file=</span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_objects</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">objects</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2022, Felipe Santana.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>